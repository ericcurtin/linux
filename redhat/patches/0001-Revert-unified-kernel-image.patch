From f1a0a12f68234258507adae03f23fa6a30c87f95 Mon Sep 17 00:00:00 2001
From: "Justin M. Forbes" <jforbes@fedoraproject.org>
Date: Thu, 23 Feb 2023 12:39:31 -0600
Subject: [PATCH 1/2] Revert "redhat: Repair ELN build broken by the recent UKI
 changes"

This reverts commit 55175d82061cf6315f512b13546ecb85c50f8fe5.
---
 redhat/kernel.spec.template | 2 ++
 redhat/rebase-notes.txt     | 2 --
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/redhat/kernel.spec.template b/redhat/kernel.spec.template
index e6631032e129..3afb41a6263f 100755
--- a/redhat/kernel.spec.template
+++ b/redhat/kernel.spec.template
@@ -726,7 +726,9 @@ BuildRequires: dracut
 BuildRequires: binutils
 # For the initrd
 BuildRequires: lvm2
+%if 0%{?fedora} > 37
 BuildRequires: systemd-boot-unsigned
+%endif
 # For systemd-stub and systemd-pcrphase
 BuildRequires: systemd-udev >= 252-1
 # For TPM operations in UKI initramfs
diff --git a/redhat/rebase-notes.txt b/redhat/rebase-notes.txt
index 02d3d8ca455d..d7dfbc97e759 100644
--- a/redhat/rebase-notes.txt
+++ b/redhat/rebase-notes.txt
@@ -3,5 +3,3 @@ Rebase notes for Fedora kernel rebases:
 6.x: Apply both patches for the simple drm nvidia work-around. From 6.1:
     e020208cd83e397e47cf2b54c4471847ff09e2ee enable efifb for Nvidia
     811fe0e4dcfd86a0db5135d3bfef4936794efdb6 drivers/firmware: skip simpledrm if nvidia-drm.modeset=1 is set
-
-Fedora 37: 'systemd-boot-unsigned' build dependency needs to be dropped.
-- 
2.39.2

From 6bfdd505960b76bf135342f2a50a4b6cd3559f60 Mon Sep 17 00:00:00 2001
From: "Justin M. Forbes" <jforbes@fedoraproject.org>
Date: Thu, 23 Feb 2023 12:40:04 -0600
Subject: [PATCH 2/2] Revert "redhat: Add sub-RPM with a EFI unified kernel
 image for virtual machines"

This reverts commit abc917343f332b870744c6c1bc4c79cc79bb8c50.
---
 redhat/Makefile             |   1 -
 redhat/dracut-virt.conf     |  35 ------------
 redhat/kernel.spec.template | 107 +-----------------------------------
 3 files changed, 1 insertion(+), 142 deletions(-)
 delete mode 100644 redhat/dracut-virt.conf

diff --git a/redhat/Makefile b/redhat/Makefile
index f9f3d8cb8fb9..80ccc4addcea 100644
--- a/redhat/Makefile
+++ b/redhat/Makefile
@@ -633,7 +633,6 @@ sources-rh: $(TARBALL) generate-testpatch-tmp setup-source dist-configs-check
 		../Makefile.rhelver \
 		README.rst \
 		kernel-local \
-		dracut-virt.conf \
 		$(SOURCES)/
 	@if [ "$(RELEASED_KERNEL)" -ne 0 ]; then \
 		cp keys/redhatsecureboot{301,501,ca5,ca1}.cer $(SOURCES)/; \
diff --git a/redhat/dracut-virt.conf b/redhat/dracut-virt.conf
deleted file mode 100644
index 3724026b0aef..000000000000
--- a/redhat/dracut-virt.conf
+++ /dev/null
@@ -1,35 +0,0 @@
-# generic + compressed please
-hostonly="no"
-compress="xz"
-
-# VMs can't update microcode anyway
-early_microcode="no"
-
-# modules: basics
-dracutmodules+=" base systemd systemd-initrd dracut-systemd dbus dbus-broker usrmount shutdown "
-
-# modules: storage support
-dracutmodules+=" dm lvm rootfs-block fs-lib "
-
-# modules: tpm and crypto
-dracutmodules+=" crypt crypt-loop tpm2-tss "
-
-# drivers: virtual buses, pci
-drivers+=" virtio-pci virtio-mmio "      # qemu-kvm
-drivers+=" hv-vmbus pci-hyperv "         # hyperv
-drivers+=" xen-pcifront "                # xen
-
-# drivers: storage
-drivers+=" ahci nvme sd_mod sr_mod "     # generic
-drivers+=" virtio-blk virtio-scsi "      # qemu-kvm
-drivers+=" hv-storvsc "                  # hyperv
-drivers+=" xen-blkfront "                # xen
-
-# root encryption
-drivers+=" dm_crypt "
-
-# filesystems
-filesystems+=" vfat ext4 xfs overlay "
-
-# systemd-pcrphase
-install_items+=" /lib/systemd/system/systemd-pcrphase-initrd.service /usr/lib/systemd/systemd-pcrphase /usr/lib/systemd/system/initrd.target.wants/systemd-pcrphase-initrd.service "
diff --git a/redhat/kernel.spec.template b/redhat/kernel.spec.template
index 3afb41a6263f..55ae0a04f326 100755
--- a/redhat/kernel.spec.template
+++ b/redhat/kernel.spec.template
@@ -106,12 +106,6 @@ Summary: The Linux kernel
 %global zipmodules 1
 %endif

-%ifarch x86_64
-%global efiuki 1
-%else
-%global efiuki 0
-%endif
-
 %if %{zipmodules}
 %global zipsed -e 's/\.ko$/\.ko.xz/'
 %endif
@@ -720,21 +714,6 @@ BuildRequires: llvm
 BuildRequires: lld
 %endif

-%if %{efiuki}
-BuildRequires: dracut
-# For dracut UEFI uki binaries
-BuildRequires: binutils
-# For the initrd
-BuildRequires: lvm2
-%if 0%{?fedora} > 37
-BuildRequires: systemd-boot-unsigned
-%endif
-# For systemd-stub and systemd-pcrphase
-BuildRequires: systemd-udev >= 252-1
-# For TPM operations in UKI initramfs
-BuildRequires: tpm2-tools
-%endif
-
 # Because this is the kernel, it's hard to get a single upstream URL
 # to represent the base without needing to do a bunch of patching. This
 # tarball is generated from a src-git tree. If you want to see the
@@ -862,8 +841,6 @@ Source82: update_scripts.sh
 Source84: mod-internal.list
 Source85: mod-partner.list

-Source86: dracut-virt.conf
-
 Source100: rheldup3.x509
 Source101: rhelkpatch1.x509

@@ -1369,13 +1346,6 @@ Requires: kernel-%{?1:%{1}-}-modules-core-uname-r = %{KVERREL}%{?1:+%{1}}\
 %endif\
 %{expand:%%kernel_debuginfo_package %{?1:%{1}}}\
 %endif\
-%if %{efiuki}\
-%package %{?1:%{1}-}uki-virt\
-Summary: %{variant_summary} unified kernel image for virtual machines\
-Provides: installonlypkg(kernel)\
-Provides: kernel-%{?1:%{1}-}uname-r = %{KVERREL}%{?1:+%{1}}\
-Requires: kernel%{?1:-%{1}}-modules-core-uname-r = %{KVERREL}%{?1:+%{1}}\
-%endif\
 %{nil}

 #
@@ -1445,14 +1415,6 @@ Linux operating system.  The kernel handles the basic functions
 of the operating system: memory allocation, process allocation, device
 input and output, etc.

-%if %{efiuki}
-%description debug-uki-virt
-Prebuilt debug unified kernel image for virtual machines.
-
-%description uki-virt
-Prebuilt default unified kernel image for virtual machines.
-%endif
-
 %if %{with_ipaclones}
 %kernel_ipaclones_package
 %endif
@@ -2237,45 +2199,6 @@ BuildKernel() {
 	touch lib/modules/$KernelVer/modules.builtin
     fi

-%if %{efiuki}
-    popd
-
-    KernelUnifiedImageDir="$RPM_BUILD_ROOT/lib/modules/$KernelVer"
-    KernelUnifiedImage="$KernelUnifiedImageDir/$InstallName-virt.efi"
-
-    mkdir -p $KernelUnifiedImageDir
-
-    dracut --conf=%{SOURCE86} \
-           --confdir=$(mktemp -d) \
-           --verbose \
-           --kver "$KernelVer" \
-           --kmoddir "$RPM_BUILD_ROOT/lib/modules/$KernelVer/" \
-           --logfile=$(mktemp) \
-           --uefi \
-           --kernel-image $(realpath $KernelImage) \
-           --kernel-cmdline 'console=tty0 console=ttyS0' \
-	   $KernelUnifiedImage
-
-%if %{signkernel}
-
-    %pesign -s -i $KernelUnifiedImage -o $KernelUnifiedImage.tmp -a %{secureboot_ca_0} -c %{secureboot_key_0} -n %{pesign_name_0}
-    %pesign -s -i $KernelUnifiedImage.tmp -o $KernelUnifiedImage.signed -a %{secureboot_ca_1} -c %{secureboot_key_1} -n %{pesign_name_1}
-    rm -f $KernelUnifiedImage.tmp
-
-    if [ ! -s $KernelUnifiedImage.signed ]; then
-      echo "pesigning failed"
-      exit 1
-    fi
-    mv $KernelUnifiedImage.signed $KernelUnifiedImage
-
-# signkernel
-%endif
-
-    pushd $RPM_BUILD_ROOT
-
-# efiuki
-%endif
-
     remove_depmod_files

     # Go back and find all of the various directories in the tree.  We use this
@@ -2962,14 +2885,12 @@ fi\
 # It also defines a %%postun script that does the same thing.
 #	%%kernel_modules_core_post [<subpackage>]
 #
-# FIXME: /bin/kernel-install can't handle UKIs (yet), so cleanup depmod files in %postun for now.
-#
 %define kernel_modules_core_post() \
 %{expand:%%posttrans %{?1:%{1}-}modules-core}\
 /sbin/depmod -a %{KVERREL}%{?1:+%{1}}\
 %{nil}\
 %{expand:%%postun %{?1:%{1}-}modules-core}\
-rm -f /lib/modules/%{KVERREL}%{?1:+%{1}}/modules.*\
+/sbin/depmod -a %{KVERREL}%{?1:+%{1}}\
 %{nil}

 # This macro defines a %%posttrans script for a kernel package.
@@ -3017,20 +2938,6 @@ mkdir -p %{_localstatedir}/lib/rpm-state/%{name}\
 touch %{_localstatedir}/lib/rpm-state/%{name}/installing_core_%{KVERREL}%{?-v:+%{-v*}}\
 %{nil}

-#
-# This macro defines scripts for a kernel*-uki-virt package
-#
-# FIXME: /bin/kernel-install can't handle UKIs (yet), so just cp/rm as temporary stop-gap
-#
-%define kernel_uki_virt_scripts() \
-%{expand:%%posttrans %{?1:%{1}-}uki-virt}\
-mkdir -p /boot/efi/EFI/Linux\
-cp /lib/modules/%{KVERREL}%{?1:+%{1}}/vmlinuz-virt.efi /boot/efi/EFI/Linux/vmlinuz-%{KVERREL}%{?1:+%{1}}-virt.efi\
-%{nil}\
-%{expand:%%postun %{?1:%{1}-}uki-virt}\
-rm -f /boot/efi/EFI/Linux/vmlinuz-%{KVERREL}%{?1:+%{1}}-virt.efi\
-%{nil}
-
 #
 # This macro defines a %%preun script for a kernel package.
 #	%%kernel_variant_preun <subpackage>
@@ -3044,10 +2951,6 @@ then\
 fi\
 %{nil}

-%if %{efiuki}
-%kernel_uki_virt_scripts
-%endif
-
 %kernel_variant_preun
 %kernel_variant_post -r kernel-smp

@@ -3057,9 +2960,6 @@ fi\
 %endif

 %if %{with_debug}
-%if %{efiuki}
-%kernel_uki_virt_scripts debug
-%endif
 %kernel_variant_preun debug
 %kernel_variant_post -v debug
 %endif
@@ -3302,11 +3202,6 @@ fi
 %{expand:%%files -f debuginfo%{?3}.list %{?3:%{3}-}debuginfo}\
 %endif\
 %endif\
-%if %{efiuki}\
-%{expand:%%files %{?3:%{3}-}uki-virt}\
-/lib/modules/%{KVERREL}%{?3:+%{3}}/%{?-k:%{-k*}}%{!?-k:vmlinuz}-virt.efi\
-%ghost /%{image_install_path}/efi/EFI/Linux/%{?-k:%{-k*}}%{!?-k:vmlinuz}-%{KVERREL}%{?3:+%{3}}-virt.efi\
-%endif\
 %if %{?3:1} %{!?3:0}\
 %{expand:%%files %{3}}\
 %endif\
-- 
2.39.2

